<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment - Marriage Education</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://js.stripe.com/v3/"></script>
  <!-- PayPal SDK with simplified configuration -->
  <script src="https://www.paypal.com/sdk/js?client-id=AV2lnBrIkt_EeUyPx_tkntdOaEPnLAlWgWs7qgj7NXT4JoMLLioU_NDJoYOOrYkCpsrfCyooDDc281qO&currency=USD&intent=capture&components=buttons"></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>Complete Your Purchase</h1>
      <nav>
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="shop.html">Shop</a>
        <a href="courses.html">Courses</a>
        <a href="blog.html">Blog</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>
  </header>

  <section class="payment-section">
    <div class="container">
      <div class="payment-container">
        <div class="order-summary">
          <h3>Order Summary</h3>
          <div class="order-item">
            <span id="modal-product-name">SBD for Dummies</span>
            <span id="modal-product-price">$19.99</span>
          </div>
          <div class="order-total">
            <strong>Total: <span id="order-total">$19.99</span></strong>
          </div>
        </div>

        <div class="payment-methods">
          <h3>Choose Payment Method</h3>
          
          <div class="payment-tabs">
            <button class="tab-button active" data-tab="stripe">Credit Card</button>
            <button class="tab-button" data-tab="paypal">PayPal</button>
          </div>

          <!-- Stripe Payment Form -->
          <div class="payment-tab active" id="stripe-tab">
            <div class="credit-card-notice">
              <h4>üí≥ Credit Card Payment</h4>
              <p><strong>Secure and Fast!</strong> Pay with your credit or debit card.</p>
              <p>Powered by <strong>Stripe</strong> - trusted by millions worldwide.</p>
            </div>
            
            <form id="stripe-payment-form" class="payment-form">
              <div class="form-group">
                <label for="customer-email">Email Address</label>
                <input type="email" id="customer-email" name="email" placeholder="Enter your email address" required />
              </div>
              
              <div class="form-group">
                <label for="customer-name">Full Name</label>
                <input type="text" id="customer-name" name="name" placeholder="Enter your full name" required />
              </div>

              <div class="form-group">
                <label>Card Information</label>
                <div id="card-element" class="card-element">
                  <!-- Stripe card element will be mounted here -->
                </div>
                <div id="card-errors" role="alert"></div>
              </div>

              <button type="submit" id="stripe-submit" class="pay-button">
                <span id="button-text">Pay Now</span>
                <span id="spinner" class="spinner hidden"></span>
              </button>
              
              <div class="security-badges">
                <div class="security-badge">
                  <span>üîí</span>
                  <span>SSL Encrypted</span>
                </div>
                <div class="security-badge">
                  <span>üí≥</span>
                  <span>PCI Compliant</span>
                </div>
                <div class="security-badge">
                  <span>üõ°Ô∏è</span>
                  <span>Fraud Protected</span>
                </div>
              </div>
            </form>
          </div>

          <!-- PayPal Payment -->
          <div class="payment-tab" id="paypal-tab">
            <div id="paypal-button-container"></div>
            <div class="security-badges">
              <div class="security-badge">
                <span>üîí</span>
                <span>Secure Payment</span>
              </div>
              <div class="security-badge">
                <span>üõ°Ô∏è</span>
                <span>Buyer Protection</span>
              </div>
              <div class="security-badge">
                <span>‚ö°</span>
                <span>Instant Processing</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Payment Modal -->
  <div id="payment-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Complete Your Purchase</h2>
      <div class="modal-body">
        <!-- Payment content will be loaded here -->
      </div>
    </div>
  </div>

  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h4>Marriage Education</h4>
          <p>Transforming relationships through proven methodologies and deep wisdom.</p>
        </div>
        <div class="footer-section">
          <h4>Security</h4>
          <p>üîí SSL Encrypted</p>
          <p>üí≥ Secure Payments</p>
          <p>üõ°Ô∏è Privacy Protected</p>
        </div>
        <div class="footer-section">
          <h4>Support</h4>
          <p>Email: support@marriageducation.com</p>
          <p>Response within 24 hours</p>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 Marriage Education. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script src="js/payment-processor.js"></script>
  <script src="js/analytics.js"></script>
  <script>
    // Get URL parameters function
    function getUrlParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      var results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    // Initialize payment page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Payment page loading...');
      
      // Get product details from URL
      const productId = getUrlParameter('product');
      const productPrice = getUrlParameter('price');
      const productName = getUrlParameter('name') || 'Marriage Education Product';

      console.log('üìã Product details:', { productId, productPrice, productName });

      // Update order summary
      if (productName && productPrice) {
        document.getElementById('modal-product-name').textContent = productName;
        document.getElementById('modal-product-price').textContent = '$' + productPrice;
        document.getElementById('order-total').textContent = '$' + productPrice;
      }

      // PayPal initialization function - simplified approach
      function initializePayPal() {
        console.log('üîç Initializing PayPal...');
        
        if (typeof paypal === 'undefined') {
          console.error('‚ùå PayPal SDK not available');
          document.getElementById('paypal-button-container').innerHTML = 
            '<div class="error-message">‚ùå PayPal SDK failed to load. Please refresh the page.</div>';
          return false;
        }

        console.log('‚úÖ PayPal SDK loaded, creating button...');
        
        try {
          paypal.Buttons({
            style: {
              layout: 'vertical',
              color: 'gold',
              shape: 'rect',
              label: 'paypal'
            },
            
            createOrder: function(data, actions) {
              console.log('üöÄ Creating PayPal order...');
              
              const price = parseFloat(productPrice || '19.99').toFixed(2);
              console.log('Order price:', price);
              
              // Simplified order structure to avoid PAYMENT_DENIED
              return actions.order.create({
                intent: 'CAPTURE',
                purchase_units: [{
                  amount: {
                    currency_code: 'USD',
                    value: price
                  },
                  description: productName || 'Marriage Education Product'
                }]
              });
            },
            
            onApprove: function(data, actions) {
              console.log('‚úÖ Payment approved, capturing...');
              
              return actions.order.capture().then(function(details) {
                console.log('‚úÖ Payment captured:', details);
                
                // Store order details
                const orderInfo = {
                  paypal_order_id: details.id,
                  product_id: productId,
                  product_name: productName,
                  amount: productPrice,
                  payer_email: details.payer?.email_address,
                  payer_name: (details.payer?.name?.given_name || '') + ' ' + (details.payer?.name?.surname || ''),
                  transaction_time: new Date().toISOString()
                };
                
                localStorage.setItem('payment_success_info', JSON.stringify(orderInfo));
                
                // Redirect to success page
                window.location.href = 'payment-success.html?order_id=' + details.id;
              });
            },
            
            onError: function(err) {
              console.error('‚ùå PayPal error:', err);
              
              let message = 'Payment error occurred.';
              if (err.message?.includes('PAYMENT_DENIED')) {
                message = 'Payment was declined. This may be due to:\n‚Ä¢ Insufficient funds\n‚Ä¢ Payment method restrictions\n‚Ä¢ Regional limitations\n\nPlease try a different payment method or contact support.';
              }
              
              alert('‚ùå ' + message);
            },
            
            onCancel: function(data) {
              console.log('üö´ Payment cancelled');
              alert('Payment was cancelled.');
            }
            
          }).render('#paypal-button-container');
          
        } catch (error) {
          console.error('‚ùå PayPal initialization error:', error);
          document.getElementById('paypal-button-container').innerHTML = 
            '<div class="error-message">‚ùå PayPal initialization failed. Please try refreshing the page.</div>';
        }
      }

      // Wait for PayPal SDK
      if (typeof paypal !== 'undefined') {
        initializePayPal();
      } else {
        let attempts = 0;
        const pollInterval = setInterval(function() {
          attempts++;
          
          if (typeof paypal !== 'undefined') {
            clearInterval(pollInterval);
            initializePayPal();
          } else if (attempts >= 50) {
            clearInterval(pollInterval);
            document.getElementById('paypal-button-container').innerHTML = 
              '<div class="error-message">‚ùå PayPal failed to load. Please refresh the page.</div>';
          }
        }, 200);
      }

      // Initialize Stripe Elements
      if (typeof Stripe !== 'undefined') {
        const stripe = Stripe('pk_live_51S4PByJFVcOiuICpKXZ5oFjIWuhbZRNuFTBdBfk8II61iBhyOVhzQQJ22AUUM938xCLobMr23IVI8miaPEmsRYTj00yKjh6776');
        const elements = stripe.elements();

        const cardElement = elements.create('card', {
          style: {
            base: {
              fontSize: '16px',
              color: '#424770',
              '::placeholder': {
                color: '#aab7c4',
              },
            },
            invalid: {
              color: '#9e2146',
            },
          },
        });

        cardElement.mount('#card-element');

        cardElement.on('change', function(event) {
          const displayError = document.getElementById('card-errors');
          if (event.error) {
            displayError.textContent = event.error.message;
          } else {
            displayError.textContent = '';
          }
        });

        // Handle Stripe form submission
        const form = document.getElementById('stripe-payment-form');
        form.addEventListener('submit', async function(event) {
          event.preventDefault();
          
          const submitButton = document.getElementById('stripe-submit');
          const buttonText = document.getElementById('button-text');
          const spinner = document.getElementById('spinner');
          
          // Show loading state
          submitButton.disabled = true;
          if (buttonText) buttonText.textContent = 'Processing...';
          if (spinner) spinner.classList.remove('hidden');
          
          const customerEmail = document.getElementById('customer-email').value;
          const customerName = document.getElementById('customer-name').value;
          
          try {
            // Create payment method
            const {paymentMethod, error} = await stripe.createPaymentMethod({
              type: 'card',
              card: cardElement,
              billing_details: {
                name: customerName,
                email: customerEmail,
              },
            });

            if (error) {
              // Show error to customer
              const errorElement = document.getElementById('card-errors');
              errorElement.textContent = error.message;
            } else {
              // Send payment method to your server (implement your backend integration here)
              console.log('‚úÖ Payment method created:', paymentMethod.id);
              
              // For demo purposes - replace with actual server call
              alert('‚úÖ Payment successful! Payment Method ID: ' + paymentMethod.id);
              
              // Redirect to success page
              window.location.href = 'payment-success.html?payment_method=' + paymentMethod.id + '&amount=' + productPrice;
            }
          } catch (err) {
            console.error('‚ùå Payment error:', err);
            document.getElementById('card-errors').textContent = 'Payment failed. Please try again.';
          }
          
          // Reset button state
          submitButton.disabled = false;
          if (buttonText) buttonText.textContent = 'Pay Now';
          if (spinner) spinner.classList.add('hidden');
        });
      }

      // Payment tab switching
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
          const tabName = this.dataset.tab;
          
          document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          
          document.querySelectorAll('.payment-tab').forEach(tab => tab.classList.remove('active'));
          document.getElementById(tabName + '-tab').classList.add('active');
        });
      });
    });
  </script>
</body>
</html>
