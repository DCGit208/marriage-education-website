<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment - Marriage Education</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>Complete Your Purchase</h1>
      <nav>
        <a href="index.html">Home</a>
        <a href="about.html">About</a>
        <a href="shop.html">Shop</a>
        <a href="courses.html">Courses</a>
        <a href="blog.html">Blog</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>
  </header>

  <section class="payment-section">
    <div class="container">
      <div class="payment-container">
        <div class="order-summary">
          <h3>Order Summary</h3>
          <div class="order-item">
            <span id="modal-product-name">SBD for Dummies</span>
            <span id="modal-product-price">$19.99</span>
          </div>
          <div class="order-total">
            <strong>Total: <span id="order-total">$19.99</span></strong>
          </div>
        </div>

        <div class="payment-methods">
          <h3>Choose Payment Method</h3>
          
          <div class="payment-methods-header">
            <h3>üí≥ Secure Credit Card Payment</h3>
            <p>Powered by Stripe - trusted by millions worldwide</p>
          </div>

          <!-- Stripe Payment Form -->
          <div class="payment-form-container" id="stripe-section">
            <div class="credit-card-notice">
              <h4>üí≥ Credit Card Payment</h4>
              <p><strong>Secure and Fast!</strong> Pay with your credit or debit card.</p>
              <p>Powered by <strong>Stripe</strong> - trusted by millions worldwide.</p>
            </div>
            
            <form id="stripe-payment-form" class="payment-form">
              <div class="form-group">
                <label for="customer-email">Email Address</label>
                <input type="email" id="customer-email" name="email" placeholder="Enter your email address" required />
              </div>
              
              <div class="form-group">
                <label for="customer-name">Full Name</label>
                <input type="text" id="customer-name" name="name" placeholder="Enter your full name" required />
              </div>

              <div class="form-group">
                <label>Card Information</label>
                <div id="card-element" class="card-element">
                  <div id="card-loading" style="padding: 12px; color: #666; font-style: italic;">
                    Loading secure payment form...
                  </div>
                </div>
                <div id="card-errors" role="alert" style="color: #fa755a; font-size: 14px; margin-top: 8px;"></div>
              </div>

              <button type="submit" id="stripe-submit" class="pay-button">
                <span id="button-text">Pay Now</span>
                <span id="spinner" class="spinner hidden"></span>
              </button>
              
              <div class="security-badges">
                <div class="security-badge">
                  <span>üîí</span>
                  <span>SSL Encrypted</span>
                </div>
                <div class="security-badge">
                  <span>üí≥</span>
                  <span>PCI Compliant</span>
                </div>
                <div class="security-badge">
                  <span>üõ°Ô∏è</span>
                  <span>Fraud Protected</span>
                </div>
              </div>
            </form>
          </div>


        </div>
      </div>
    </div>
  </section>

  <!-- Payment Modal -->
  <div id="payment-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Complete Your Purchase</h2>
      <div class="modal-body">
        <!-- Payment content will be loaded here -->
      </div>
    </div>
  </div>

  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h4>Marriage Education</h4>
          <p>Transforming relationships through proven methodologies and deep wisdom.</p>
        </div>
        <div class="footer-section">
          <h4>Security</h4>
          <p>üîí SSL Encrypted</p>
          <p>üí≥ Secure Payments</p>
          <p>üõ°Ô∏è Privacy Protected</p>
        </div>
        <div class="footer-section">
          <h4>Support</h4>
          <p>Email: support@marriageducation.com</p>
          <p>Response within 24 hours</p>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 Marriage Education. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script src="js/payment-processor.js"></script>
  <script src="js/analytics.js"></script>
  <script>
    // Get URL parameters function
    function getUrlParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      var results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    // Initialize payment page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Payment page loading...');
      
      // Get product details from URL
      const productId = getUrlParameter('product');
      const productPrice = getUrlParameter('price');
      const productName = getUrlParameter('name') || 'Marriage Education Product';

      console.log('üìã Product details:', { productId, productPrice, productName });

      // Update order summary
      if (productName && productPrice) {
        document.getElementById('modal-product-name').textContent = productName;
        document.getElementById('modal-product-price').textContent = '$' + productPrice;
        document.getElementById('order-total').textContent = '$' + productPrice;
      }

      

      // Initialize Stripe Elements with timeout
      function initializeStripe() {
        console.log('üîç Initializing Stripe...');
        
        if (typeof Stripe === 'undefined') {
          console.error('‚ùå Stripe SDK not loaded');
          document.getElementById('card-element').innerHTML = 
            '<div id="stripe-error">‚ùå Payment system loading failed. Please refresh the page.</div>';
          return;
        }

        try {
          const stripe = Stripe('pk_live_51S4PByJFVcOiuICpKXZ5oFjIWuhbZRNuFTBdBfk8II61iBhyOVhzQQJ22AUUM938xCLobMr23IVI8miaPEmsRYTj00yKjh6776');
          const elements = stripe.elements();

          const cardElement = elements.create('card', {
            style: {
              base: {
                fontSize: '18px',
                color: '#424770',
                fontFamily: 'Arial, sans-serif',
                '::placeholder': {
                  color: '#aab7c4',
                },
                lineHeight: '48px',
              },
              invalid: {
                color: '#fa755a',
                iconColor: '#fa755a'
              }
            }
          });

          // Clear loading and mount
          const cardContainer = document.getElementById('card-element');
          const loadingDiv = document.getElementById('card-loading');
          if (loadingDiv) loadingDiv.remove();
          
          cardElement.mount('#card-element');
          
          console.log('‚úÖ Stripe mounted successfully');

          // Event listeners
          cardElement.on('change', function(event) {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
              displayError.textContent = event.error.message;
            } else {
              displayError.textContent = '';
            }
          });

          cardElement.on('ready', function() {
            console.log('‚úÖ Card element ready');
          });

          // Store for form submission
          window.stripeInstance = stripe;
          window.cardElement = cardElement;

        } catch (error) {
          console.error('‚ùå Stripe error:', error);
          document.getElementById('card-element').innerHTML = 
            '<div id="stripe-error">‚ùå Payment form error. Please refresh the page.</div>';
        }
      }

      // Wait for Stripe SDK or timeout
      let attempts = 0;
      const maxAttempts = 50;
      const checkStripe = setInterval(function() {
        attempts++;
        if (typeof Stripe !== 'undefined') {
          clearInterval(checkStripe);
          initializeStripe();
        } else if (attempts >= maxAttempts) {
          clearInterval(checkStripe);
          document.getElementById('card-element').innerHTML = 
            '<div id="stripe-error">‚ùå Payment system failed to load. Please refresh the page.</div>';
        }
      }, 100);

      // Handle Stripe form submission (using global references)
      const form = document.getElementById('stripe-payment-form');
      if (form) {
        form.addEventListener('submit', async function(event) {
          event.preventDefault();
          
          // Check if Stripe is available
          if (!window.stripeInstance || !window.cardElement) {
            alert('Payment system not ready. Please refresh the page.');
            return;
          }
          
          const submitButton = document.getElementById('stripe-submit');
          const buttonText = document.getElementById('button-text');
          const spinner = document.getElementById('spinner');
          
          // Show loading state
          submitButton.disabled = true;
          if (buttonText) buttonText.textContent = 'Processing...';
          if (spinner) spinner.classList.remove('hidden');
          
          const customerEmail = document.getElementById('customer-email').value;
          const customerName = document.getElementById('customer-name').value;
          
          try {
            // Create payment method
            const {paymentMethod, error} = await window.stripeInstance.createPaymentMethod({
              type: 'card',
              card: window.cardElement,
              billing_details: {
                name: customerName,
                email: customerEmail,
              },
            });

            if (error) {
              // Show error to customer
              const errorElement = document.getElementById('card-errors');
              errorElement.textContent = error.message;
            } else {
              // Send payment method to your server (implement your backend integration here)
              console.log('‚úÖ Payment method created:', paymentMethod.id);
              
              // For demo purposes - replace with actual server call
              alert('‚úÖ Payment successful! Payment Method ID: ' + paymentMethod.id);
              
              // Redirect to success page
              window.location.href = 'payment-success.html?payment_method=' + paymentMethod.id + '&amount=' + productPrice;
            }
          } catch (err) {
            console.error('‚ùå Payment error:', err);
            document.getElementById('card-errors').textContent = 'Payment failed. Please try again.';
          }
          
          // Reset button state
          submitButton.disabled = false;
          if (buttonText) buttonText.textContent = 'Pay Now';
          if (spinner) spinner.classList.add('hidden');
        });
      }

      // No tab switching needed - single payment method
    });
  </script>
</body>
</html>
